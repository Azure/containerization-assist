name: Test Containerization Capability

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-containerization:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      AZURE_OPENAI_DEPLOYMENT_ID: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_ID }}
      AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Setup Docker and Kubernetes tools
        run: |
          # Verify Docker is working
          docker --version
          docker info
          
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
          
          # Install kind (Kubernetes in Docker)
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version
          
      - name: Install mcphost
        run: |
          echo "Installing mcphost binary..."
          # Use specific version v0.26.1 - download the correct Linux x86_64 archive
          VERSION="v0.26.1"
          echo "Installing mcphost version: $VERSION"
          
          # Download and extract mcphost binary from tar.gz
          curl -L -o mcphost.tar.gz "https://github.com/mark3labs/mcphost/releases/download/${VERSION}/mcphost_Linux_x86_64.tar.gz"
          tar -xzf mcphost.tar.gz
          chmod +x mcphost
          sudo mv mcphost /usr/local/bin/
          rm -f mcphost.tar.gz
          mcphost --version
          echo "✅ mcphost v0.26.1 installed successfully"
          
      - name: Build MCP Server from PR
        run: |
          echo "Building Container Kit MCP Server from PR code..."
          go build -tags mcp -o container-kit-mcp ./cmd/mcp-server
          chmod +x container-kit-mcp
          ls -la container-kit-mcp
          echo "✅ MCP Server binary ready"
          
      - name: Create mcphost configuration
        run: |
          echo "Creating mcphost configuration..."
          mkdir -p ~/.config/mcphost
          
          # Copy the main configuration template
          cp .github/workflows/mcphost/config.yml ~/.mcphost.yml
          
          echo "Configuration created successfully"
          
          # Create workspace directory and copy MCP binary there
          mkdir -p /tmp/test-workspace
          cp ./container-kit-mcp /tmp/test-workspace/
          
          # Also ensure the binary is in the current directory for mcphost
          ls -la ./container-kit-mcp
          
          # Show the full configuration
          echo "=== mcphost configuration ==="
          cat ~/.mcphost.yml
          echo ""
          
      - name: Test MCP Server and LLM connection
        run: |
          echo "Testing MCP Server and LLM connection..."
          echo "Current working directory: $(pwd)"
          echo "MCP Server binary location:"
          ls -la ./container-kit-mcp
          echo ""
          
          # Simple test to verify MCP tools are loaded
          set +e
          HELLO_RESULT=$(timeout 30s mcphost --quiet --stream=false -p "If you have access to containerization tools (mcp_containerkit tools), respond with 'successful'. If you do not have access to containerization tools, respond with 'unsuccessful' and nothing else." 2>&1)
          HELLO_EXIT_CODE=$?
          set -e
          
          echo "=== MCP TOOLS TEST OUTPUT ==="
          echo "$HELLO_RESULT"
          echo "=== END TOOLS TEST ==="
          echo ""
          
          # Check for explicit unsuccessful response
          if echo "$HELLO_RESULT" | grep -i "unsuccessful" > /dev/null; then
            echo "❌ CRITICAL: MCP server failed - LLM responded 'unsuccessful'"
            echo "This means containerization tools are not available."
            echo "Stopping execution."
            exit 1
          elif echo "$HELLO_RESULT" | grep -i "successful" > /dev/null; then
            echo "✅ MCP tools test PASSED - Container tools are available"
          else
            echo "❌ MCP tools test FAILED - Unexpected response"
            echo "Expected 'successful' or 'unsuccessful' but got different response"
            echo "Full response for analysis:"
            echo "\"$HELLO_RESULT\""
            exit 1
          fi
          echo ""
          
      - name: Run containerization test
        id: test
        run: |
          echo "Running containerization test..."
          echo "Current working directory: $(pwd)"
          echo "MCP Server will be started by mcphost via stdio"
          echo ""
          
          # Test with a simple Java servlet application using mcphost
          # mcphost will start the MCP server via stdio and communicate directly
          echo "Starting mcphost with containerization request..."
          echo "MCP server will be started automatically by mcphost via stdio"
          echo ""
          
          # Capture both stdout and stderr, and don't exit on failure
          set +e
          RESULT=$(timeout 300s mcphost --stream=false --compact -p "Please containerize this repository: https://github.com/GRomR1/java-servlet-hello. This is an automated test - do NOT ask for user input." 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo ""
          echo "Test completed with exit code: $EXIT_CODE"
          echo ""
          echo "=== MCPHOST OUTPUT ==="
          echo "$RESULT"
          echo "=== END OUTPUT ==="
          echo ""
          
      - name: Analyze results and report
        run: |
          echo "=== Output-Based Analysis ==="
          
          # Analyze mcphost output for success indicators
          SUCCESS=false
          SUCCESS_REASON="Unknown"
          
          # Check if containerization workflow completed successfully
          if echo "$RESULT" | grep -qi "successfully containerized\|completed successfully\|containerization.*success\|workflow.*completed\|process.*completed successfully"; then
            SUCCESS=true
            SUCCESS_REASON="Output indicates successful containerization workflow completion"
          elif echo "$RESULT" | grep -qi "containerized.*ready\|deployment.*ready\|application.*ready"; then
            SUCCESS=true
            SUCCESS_REASON="Output indicates application is ready and containerized"
          elif echo "$RESULT" | grep -qi "successfully.*generated\|successfully.*built\|successfully.*deployed"; then
            SUCCESS=true
            SUCCESS_REASON="Output indicates successful completion of containerization steps"
          elif echo "$RESULT" | grep -qi "error\|failed\|timeout\|unable to\|could not.*complete"; then
            SUCCESS=false
            SUCCESS_REASON="Output indicates errors or failures"
          elif [ "$EXIT_CODE" -eq 0 ]; then
            SUCCESS=true
            SUCCESS_REASON="Process completed with success exit code"
          else
            SUCCESS=false
            SUCCESS_REASON="Process completed with error exit code: $EXIT_CODE"
          fi

          echo "=== Analysis Details ==="
          echo "Exit code: $EXIT_CODE"
          echo "Success indicators found:"
          echo "$RESULT" | grep -i "success\|completed\|containerized\|ready" | head -5 || echo "None found"
          echo ""
          echo "Error indicators found:"
          echo "$RESULT" | grep -i "error\|failed\|timeout" | head -5 || echo "None found"
          echo ""

          if [ "$SUCCESS" = "true" ]; then
            echo "✅ Containerization test PASSED (Output Analysis)"
            echo "SUCCESS: $SUCCESS_REASON"
            exit 0
          else
            echo "❌ Containerization test FAILED (Output Analysis)"
            echo "FAILURE: $SUCCESS_REASON"
            echo ""
            echo "Full output analysis:"
            echo "$RESULT" | grep -i "error\|failed\|success\|completed" | head -10 || echo "No clear success/failure indicators found"
            exit 1
          fi
          
      - name: Show generated artifacts and deployment status
        if: always()
        run: |
          echo "=== POST-TEST ARTIFACTS AND STATUS ==="
          echo ""
          
          echo "=== mcphost Output Analysis ==="
          if [ -n "$RESULT" ]; then
            echo "mcphost execution summary:"
            echo "$RESULT" | grep -E "(✅|❌|success|fail|error|complete)" | head -10 || echo "No clear status indicators found"
          else
            echo "No mcphost output captured"
          fi
          echo ""
          
          echo "=== Kubernetes Pods Status ==="
          if command -v kubectl &> /dev/null; then
            # Try to get pods from default namespace and any detected namespaces
            echo "Checking pods in default namespace:"
            kubectl get pods -o wide 2>/dev/null || echo "No pods found or kubectl not configured"
            echo ""
            
            # Check for any java-servlet or app-related pods in all namespaces
            echo "Searching for application pods across all namespaces:"
            kubectl get pods --all-namespaces | grep -i "java\|servlet\|app" 2>/dev/null || echo "No application pods found"
            echo ""
            
            # Show services as well
            echo "Services:"
            kubectl get services -o wide 2>/dev/null || echo "No services found"
            echo ""
          else
            echo "kubectl not available"
          fi
          
          echo "=== Generated Dockerfile ==="
          # Look for Dockerfile in common locations
          if [ -f "Dockerfile" ]; then
            echo "Found Dockerfile in root:"
            cat Dockerfile
          elif [ -f "/tmp/test-workspace/Dockerfile" ]; then
            echo "Found Dockerfile in test workspace:"
            cat /tmp/test-workspace/Dockerfile
          elif find /tmp -name "Dockerfile" -type f 2>/dev/null | head -1 | xargs test -f; then
            DOCKERFILE_PATH=$(find /tmp -name "Dockerfile" -type f 2>/dev/null | head -1)
            echo "Found Dockerfile at: $DOCKERFILE_PATH"
            cat "$DOCKERFILE_PATH"
          else
            echo "No Dockerfile found"
          fi
          echo ""
          
          echo "=== Generated Kubernetes Manifests ==="
          # Look for manifest files in common locations
          MANIFEST_FOUND=false
          for pattern in "*.yaml" "*.yml" "*manifest*" "*deployment*" "*service*"; do
            if find /tmp -name "$pattern" -type f 2>/dev/null | grep -v mcphost-config | head -5; then
              MANIFEST_FOUND=true
              echo ""
              find /tmp -name "$pattern" -type f 2>/dev/null | grep -v mcphost-config | head -5 | while read -r manifest; do
                echo "=== Manifest: $manifest ==="
                cat "$manifest"
                echo ""
              done
            fi
          done
          
          if [ "$MANIFEST_FOUND" = false ]; then
            echo "No Kubernetes manifest files found"
          fi
          
          echo "=== Docker Images ==="
          echo "Available Docker images:"
          docker images | head -10 || echo "Unable to list Docker images"
          echo ""
          
          echo "=== Working Directory Contents ==="
          ls -la
          echo ""
          
          echo "=== Temp Directory Structure ==="
          find /tmp -type f -name "*.yaml" -o -name "*.yml" -o -name "Dockerfile" 2>/dev/null | head -10 || echo "No relevant files found in temp"
