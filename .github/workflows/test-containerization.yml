name: Test Containerization Capability

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-containerization:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      AZURE_OPENAI_DEPLOYMENT_ID: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_ID }}
      AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Setup Docker and Kubernetes tools
        run: |
          # Verify Docker is working
          docker --version
          docker info
          
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
          
          # Install kind (Kubernetes in Docker)
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version
          
      - name: Install mcphost
        run: |
          echo "Installing mcphost binary..."
          # Use specific version v0.26.1 - download the correct Linux x86_64 archive
          VERSION="v0.26.1"
          echo "Installing mcphost version: $VERSION"
          
          # Download and extract mcphost binary from tar.gz
          curl -L -o mcphost.tar.gz "https://github.com/mark3labs/mcphost/releases/download/${VERSION}/mcphost_Linux_x86_64.tar.gz"
          tar -xzf mcphost.tar.gz
          chmod +x mcphost
          sudo mv mcphost /usr/local/bin/
          rm -f mcphost.tar.gz
          mcphost --version
          echo "âœ… mcphost v0.26.1 installed successfully"
          
      - name: Build MCP Server from PR
        run: |
          echo "Building Container Kit MCP Server from PR code..."
          go build -tags mcp -o container-kit-mcp ./cmd/mcp-server
          chmod +x container-kit-mcp
          ls -la container-kit-mcp
          echo "âœ… MCP Server binary ready"
          
      - name: Create mcphost configuration
        run: |
          echo "Creating mcphost configuration..."
          mkdir -p ~/.config
          
          # Copy the configuration template (mcphost will handle env var substitution)
          cp .github/workflows/mcphost/config.yml ~/.mcphost.yml
          
          echo "Configuration created successfully"
          
          # Create workspace directory and copy MCP binary there
          mkdir -p /tmp/test-workspace
          cp ./container-kit-mcp /tmp/test-workspace/
          
          # Also ensure the binary is in the current directory for mcphost
          ls -la ./container-kit-mcp
          
          # Show the full configuration
          echo "=== mcphost configuration ==="
          cat ~/.mcphost.yml
          
      - name: Setup mcphost hooks for monitoring
        run: |
          echo "Setting up mcphost hooks for containerization monitoring..."
          
          # Install jq for JSON parsing in hooks
          sudo apt-get update && sudo apt-get install -y jq
          
          # Copy hook script and make it executable
          cp .github/workflows/mcphost/track-tool-success.sh /tmp/track-tool-success.sh
          chmod +x /tmp/track-tool-success.sh
          
          # Verify hook script exists and is executable
          ls -la /tmp/track-tool-success.sh
          
          # Initialize empty hook log file
          touch /tmp/workflow-hooks.log
          
          echo "âœ… mcphost hooks configured successfully"
          echo "Hook script location: /tmp/track-tool-success.sh"
          
      - name: Test MCP Server and LLM connection
        run: |
          echo "Testing MCP Server and LLM connection..."
          echo "Current working directory: $(pwd)"
          echo "MCP Server binary location:"
          ls -la ./container-kit-mcp
          echo ""
          
          # Simple test to verify MCP tools are loaded
          set +e
          HELLO_RESULT=$(timeout 30s mcphost --stream=false -p "If you have access to containerization tools (mcp_containerkit tools), respond with 'successful'. If you do not have access to containerization tools, respond with 'unsuccessful' and nothing else." 2>&1)
          HELLO_EXIT_CODE=$?
          set -e
          
          echo "=== MCP TOOLS TEST OUTPUT ==="
          echo "$HELLO_RESULT"
          echo "=== END TOOLS TEST ==="
          echo ""
          
          # Check for explicit unsuccessful response
          if echo "$HELLO_RESULT" | grep -i "unsuccessful" > /dev/null; then
            echo "âŒ CRITICAL: MCP server failed - LLM responded 'unsuccessful'"
            echo "This means containerization tools are not available."
            echo "Stopping execution."
            exit 1
          elif echo "$HELLO_RESULT" | grep -i "successful" > /dev/null; then
            echo "âœ… MCP tools test PASSED - Container tools are available"
          else
            echo "âŒ MCP tools test FAILED - Unexpected response"
            echo "Expected 'successful' or 'unsuccessful' but got different response"
            exit 1
          fi
          echo ""
          
      - name: Run containerization test
        id: test
        run: |
          echo "Running containerization test..."
          echo "Current working directory: $(pwd)"
          echo "MCP Server will be started by mcphost via stdio"
          echo ""
          
          # Test with a simple Java servlet application using mcphost
          # mcphost will start the MCP server via stdio and communicate directly
          echo "Starting mcphost with containerization request..."
          echo "MCP server will be started automatically by mcphost via stdio"
          echo ""
          
          # Capture both stdout and stderr, and don't exit on failure
          set +e
          RESULT=$(mcphost --stream=false --max-steps 60 -p "Please containerize this repository: https://github.com/GRomR1/java-servlet-hello. If you encounter any errors during deployment, please attempt to fix them automatically or provide specific recommendations. Do not ask for user input - proceed with reasonable defaults and complete the containerization process." 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo ""
          echo "Test completed with exit code: $EXIT_CODE"
          echo ""
          echo "=== MCPHOST OUTPUT ==="
          echo "$RESULT"
          echo "=== END OUTPUT ==="
          echo ""
          
          # Use a delimiter that won't conflict with the output content
          {
            echo "result<<MCPHOST_OUTPUT_EOF"
            echo "$RESULT"
            echo "MCPHOST_OUTPUT_EOF"
          } >> $GITHUB_OUTPUT
          
      - name: Analyze results and report
        run: |
          echo "=== Test Result and Logs ==="
          # Clean the output by removing ANSI escape sequences and control characters
          CLEAN_RESULT='${{ steps.test.outputs.result }}'
          
          # Remove ANSI escape sequences, control chars, and excessive whitespace
          CLEAN_RESULT=$(echo "$CLEAN_RESULT" | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\000-\010\013\014\016-\037' | sed 's/[[:space:]]*$//' | sed '/^$/d')
          
          # Filter out the TTY and spinner errors, but keep meaningful content
          FILTERED_RESULT=$(echo "$CLEAN_RESULT" | grep -v "Error running spinner" | grep -v "could not open a new TTY" | grep -v "no such device or address" | sed '/^[[:space:]]*$/d')
          
          echo "Filtered mcphost output:"
          echo "$FILTERED_RESULT"
          echo ""
          
          echo "=== Hook-Based Analysis ==="
          if [ -f "/tmp/workflow-hooks.log" ]; then
            echo "Hook execution log found. Analyzing tool success status..."
            cat /tmp/workflow-hooks.log
            echo ""
            
            # Count successful tools from hook logs
            SUCCESSFUL_TOOLS=$(grep -c "âœ… Tool completed successfully" /tmp/workflow-hooks.log || echo "0")
            FAILED_TOOLS=$(grep -c "âŒ Tool failed" /tmp/workflow-hooks.log || echo "0")
            CONTAINER_TOOLS=$(grep -c "ðŸ”§ Container tool executed" /tmp/workflow-hooks.log || echo "0")
            
            echo "=== Hook Analysis Summary ==="
            echo "Container tools executed: $CONTAINER_TOOLS"
            echo "Successful tools: $SUCCESSFUL_TOOLS"
            echo "Failed tools: $FAILED_TOOLS"
            echo ""
            
            # Determine success based on hook evidence
            SUCCESS=false
            SUCCESS_REASON="Unknown"
            
            # Check for final milestone (highest priority)
            if grep -q "ðŸŽ‰ SUCCESS: Application fully containerized and deployed!" /tmp/workflow-hooks.log; then
              SUCCESS=true
              SUCCESS_REASON="Final success milestone reached"
            # Check if we have any successful container tools
            elif [ "$SUCCESSFUL_TOOLS" -gt 0 ] && [ "$FAILED_TOOLS" -eq 0 ]; then
              SUCCESS=true
              SUCCESS_REASON="Container tools executed successfully ($SUCCESSFUL_TOOLS tools)"
            # If no container tools were called, it means hooks are working but mcphost didn't use our MCP server
            elif [ "$CONTAINER_TOOLS" -eq 0 ]; then
              SUCCESS=false
              SUCCESS_REASON="No container tools were executed - MCP server may not be loaded"
            fi

            if [ "$SUCCESS" = "true" ]; then
              echo "âœ… Containerization test PASSED (Hook Verification)"
              echo "SUCCESS: $SUCCESS_REASON"
              echo ""
              echo "=== Completed Milestones ==="
              grep "MILESTONE:" /tmp/workflow-hooks.log | sed 's/.*MILESTONE: /- /' || echo "No milestone details found"
              exit 0
            else
              echo "âŒ Containerization test FAILED (Hook Verification)"
              echo "FAILURE: $SUCCESS_REASON"
              
              if [ "$CONTAINER_TOOLS" -eq 0 ]; then
                echo ""
                echo "=== Diagnosis ==="
                echo "The MCP server appears to not be loaded properly."
                echo "Check mcphost output for MCP server loading errors:"
                echo "$FILTERED_RESULT" | grep -i "container-copilot\|mcp\|server\|failed\|error" || echo "No MCP-related messages found"
                echo ""
                echo "Possible causes:"
                echo "- container-kit-mcp binary failed to start"
                echo "- MCP server initialization timeout"
                echo "- Transport/communication errors"
              elif [ "$FAILED_TOOLS" -gt 0 ]; then
                echo ""
                echo "=== Failed Tools ==="
                grep "âŒ Tool failed" /tmp/workflow-hooks.log || echo "No failed tool details found"
              fi
              exit 1
            fi
          else
            echo "âŒ CRITICAL: No hook logs found - hooks are not working!"
            echo "FAILURE: Hook-based verification is required but hooks did not execute"
            echo ""
            echo "This indicates a problem with:"
            echo "- mcphost hooks configuration"
            echo "- Hook script execution permissions"
            echo "- PostToolUse hook not being triggered"
            echo ""
            echo "Please check the hook setup and mcphost configuration."
            exit 1
          fi
          
      - name: Show generated artifacts and deployment status
        if: always()
        run: |
          echo "=== POST-TEST ARTIFACTS AND STATUS ==="
          echo ""
          
          echo "=== Workflow Hook Logs ==="
          if [ -f "/tmp/workflow-hooks.log" ]; then
            echo "Hook execution log:"
            cat /tmp/workflow-hooks.log
            echo ""
            echo "Hook Summary:"
            echo "- Successful tools: $(grep -c "âœ… Tool completed successfully" /tmp/workflow-hooks.log || echo "0")"
            echo "- Failed tools: $(grep -c "âŒ Tool failed" /tmp/workflow-hooks.log || echo "0")"
            echo "- Milestones reached: $(grep -c "MILESTONE:" /tmp/workflow-hooks.log || echo "0")"
            echo "- Final success: $(grep -c "ðŸŽ‰ SUCCESS:" /tmp/workflow-hooks.log || echo "0")"
          else
            echo "No hook logs found"
          fi
          echo ""
          
          echo "=== Kubernetes Pods Status ==="
          if command -v kubectl &> /dev/null; then
            # Try to get pods from default namespace and any detected namespaces
            echo "Checking pods in default namespace:"
            kubectl get pods -o wide 2>/dev/null || echo "No pods found or kubectl not configured"
            echo ""
            
            # Check for any java-servlet or app-related pods in all namespaces
            echo "Searching for application pods across all namespaces:"
            kubectl get pods --all-namespaces | grep -i "java\|servlet\|app" 2>/dev/null || echo "No application pods found"
            echo ""
            
            # Show services as well
            echo "Services:"
            kubectl get services -o wide 2>/dev/null || echo "No services found"
            echo ""
          else
            echo "kubectl not available"
          fi
          
          echo "=== Generated Dockerfile ==="
          # Look for Dockerfile in common locations
          if [ -f "Dockerfile" ]; then
            echo "Found Dockerfile in root:"
            cat Dockerfile
          elif [ -f "/tmp/test-workspace/Dockerfile" ]; then
            echo "Found Dockerfile in test workspace:"
            cat /tmp/test-workspace/Dockerfile
          elif find /tmp -name "Dockerfile" -type f 2>/dev/null | head -1 | xargs test -f; then
            DOCKERFILE_PATH=$(find /tmp -name "Dockerfile" -type f 2>/dev/null | head -1)
            echo "Found Dockerfile at: $DOCKERFILE_PATH"
            cat "$DOCKERFILE_PATH"
          else
            echo "No Dockerfile found"
          fi
          echo ""
          
          echo "=== Generated Kubernetes Manifests ==="
          # Look for manifest files in common locations
          MANIFEST_FOUND=false
          for pattern in "*.yaml" "*.yml" "*manifest*" "*deployment*" "*service*"; do
            if find /tmp -name "$pattern" -type f 2>/dev/null | grep -v mcphost-config | head -5; then
              MANIFEST_FOUND=true
              echo ""
              find /tmp -name "$pattern" -type f 2>/dev/null | grep -v mcphost-config | head -5 | while read -r manifest; do
                echo "=== Manifest: $manifest ==="
                cat "$manifest"
                echo ""
              done
            fi
          done
          
          if [ "$MANIFEST_FOUND" = false ]; then
            echo "No Kubernetes manifest files found"
          fi
          
          echo "=== Docker Images ==="
          echo "Available Docker images:"
          docker images | head -10 || echo "Unable to list Docker images"
          echo ""
          
          echo "=== Working Directory Contents ==="
          ls -la
          echo ""
          
          echo "=== Temp Directory Structure ==="
          find /tmp -type f -name "*.yaml" -o -name "*.yml" -o -name "Dockerfile" 2>/dev/null | head -10 || echo "No relevant files found in temp"
