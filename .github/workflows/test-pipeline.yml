name: Test Pipeline

on:
  push:
    branches: [ main, develop, 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'

jobs:
  # Single test job with all essential validations
  test:
    name: Tests & Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore build cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            dist
            dist-cjs
            .tsbuildinfo
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*.ts', 'tsconfig*.json', 'package-lock.json') }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run validation pipeline
        id: validation
        run: npm run validate > quality-full.txt 2>&1 || true
        env:
          DOCKER_AVAILABLE: true

      - name: Run all tests
        id: npmtest
        run: npm test

      - name: Verify build artifacts
        run: |
          echo "Verifying ESM build artifacts..."
          test -f dist/src/index.js || { echo "âŒ ESM index.js missing"; exit 1; }
          test -f dist/src/index.d.ts || { echo "âŒ ESM index.d.ts missing"; exit 1; }
          test -x dist/src/cli/cli.js || { echo "âŒ CLI not executable"; exit 1; }

          echo "Verifying CJS build artifacts..."
          test -f dist-cjs/src/index.js || { echo "âŒ CJS index.js missing"; exit 1; }
          test -f dist-cjs/src/index.d.ts || { echo "âŒ CJS index.d.ts missing"; exit 1; }

          echo "Verifying ESM imports have .js extensions..."
          if grep -r "from ['\"]\.\.\/[^'\"]*['\"]" dist/src --include="*.js" | grep -v "\.js['\"]"; then
            echo "âŒ Found ESM imports without .js extensions"
            exit 1
          fi

          echo "âœ… Build artifact verification passed"

      - name: Run quality gates
        id: quality
        run: |
          # Run quality gates (non-blocking for reporting) with baseline updates
          UPDATE_BASELINES=true npm run quality:gates > quality-gates.txt 2>&1 || true

          # Extract metrics from outputs - ensure single line values
          CURRENT_WARNINGS=$(grep "Total warnings:" quality-full.txt | sed 's/.*Total warnings: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "0")
          BASELINE_WARNINGS=$(grep "Baseline:" quality-full.txt | sed 's/.*Baseline: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "1048")
          REDUCTION=$(grep "Reduced by:" quality-full.txt | sed 's/.*Reduced by: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "0")
          PERCENTAGE=$(grep "Reduced by:" quality-full.txt | sed 's/.*(\([0-9][0-9]*\.[0-9][0-9]*\)%).*/\1/' | head -1 | tr -cd '0-9.' || echo "0")

          UNUSED_EXPORTS=$(grep "Total unused exports:" quality-full.txt | sed 's/.*Total unused exports: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "0")
          DEADCODE_BASELINE=$(grep "Baseline:.*unused exports" quality-full.txt | sed 's/.*Baseline: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "441")
          DEADCODE_REDUCTION=$(grep "Reduced by:.*exports" quality-full.txt | sed 's/.*Reduced by: \([0-9][0-9]*\).*/\1/' | head -1 | tr -cd '0-9' || echo "0")

          # Quality gates status - count exact matches and ensure single digits
          GATES_PASSED=$(grep -o "âœ… PASS:" quality-gates.txt 2>/dev/null | wc -l | tr -cd '0-9' || echo "0")
          GATES_FAILED=$(grep -o "âŒ FAIL:" quality-gates.txt 2>/dev/null | wc -l | tr -cd '0-9' || echo "0")
          GATES_WARNINGS=$(grep -o "âš ï¸  WARN:" quality-gates.txt 2>/dev/null | wc -l | tr -cd '0-9' || echo "0")

          # Validate all values are proper integers
          for var in CURRENT_WARNINGS BASELINE_WARNINGS REDUCTION UNUSED_EXPORTS DEADCODE_BASELINE DEADCODE_REDUCTION GATES_PASSED GATES_FAILED GATES_WARNINGS; do
            value=$(eval echo \$$var)
            if ! [[ "$value" =~ ^[0-9]+$ ]]; then
              echo "Warning: $var has invalid value '$value', setting to 0"
              eval "$var=0"
            fi
          done

          # Validate percentage is a number (can have decimal)
          if ! [[ "$PERCENTAGE" =~ ^[0-9]+\.?[0-9]*$ ]] && [ "$PERCENTAGE" != "N/A" ]; then
            echo "Warning: PERCENTAGE has invalid value '$PERCENTAGE', setting to 0"
            PERCENTAGE="0"
          fi

          # Determine status
          if [ "$GATES_FAILED" -eq 0 ] && [ "$CURRENT_WARNINGS" -le "$BASELINE_WARNINGS" ]; then
            STATUS="âœ… EXCELLENT"
          elif [ "$GATES_FAILED" -eq 0 ]; then
            STATUS="âœ… PASSING"
          elif [ "$GATES_FAILED" -le 2 ]; then
            STATUS="âš ï¸ NEEDS ATTENTION"
          else
            STATUS="âŒ REQUIRES FIXES"
          fi

          # Set outputs
          echo "current_warnings=${CURRENT_WARNINGS}" >> $GITHUB_OUTPUT
          echo "baseline_warnings=${BASELINE_WARNINGS}" >> $GITHUB_OUTPUT
          echo "warning_reduction=${REDUCTION}" >> $GITHUB_OUTPUT
          echo "warning_percentage=${PERCENTAGE}" >> $GITHUB_OUTPUT
          echo "unused_exports=${UNUSED_EXPORTS}" >> $GITHUB_OUTPUT
          echo "deadcode_baseline=${DEADCODE_BASELINE}" >> $GITHUB_OUTPUT
          echo "deadcode_reduction=${DEADCODE_REDUCTION}" >> $GITHUB_OUTPUT
          echo "gates_passed=${GATES_PASSED}" >> $GITHUB_OUTPUT
          echo "gates_failed=${GATES_FAILED}" >> $GITHUB_OUTPUT
          echo "gates_warnings=${GATES_WARNINGS}" >> $GITHUB_OUTPUT
          echo "overall_status=${STATUS}" >> $GITHUB_OUTPUT

      - name: Extract top warning types
        id: warnings
        run: |
          TOP_WARNINGS=$(grep -A 10 "=== Top.*Warning Types ===" quality-full.txt | tail -n +2 | head -n 5 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' || echo "No warnings found")
          echo "top_warnings<<EOF" >> $GITHUB_OUTPUT
          echo "$TOP_WARNINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract coverage metrics
        id: coverage
        continue-on-error: true
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            OVERALL=$(jq -r '.total.statements.pct' coverage/coverage-summary.json 2>/dev/null || echo "0")
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json 2>/dev/null || echo "0")
          else
            OVERALL=0
            BRANCHES=0
          fi
          echo "overall_coverage=$OVERALL" >> $GITHUB_OUTPUT
          echo "branch_coverage=$BRANCHES" >> $GITHUB_OUTPUT

      - name: Upload build artifacts for reuse
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: build-${{ github.run_id }}
          path: |
            dist/
            dist-cjs/
          retention-days: 1

      - name: Upload node_modules for security scan
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: node-modules-${{ github.run_id }}
          path: node_modules/
          retention-days: 1

      - name: Upload quality artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: quality-report-${{ github.run_id }}
          path: |
            quality-full.txt
            quality-gates.txt
            coverage/
          retention-days: 7

      # Generate and post PR comment for pull requests only
      - name: Generate PR quality comment
        if: github.event_name == 'pull_request'
        run: |
          cat > pr_comment.md << EOF
          ## ðŸ›¡ï¸ Code Quality Report

          **Status:** ${{ steps.quality.outputs.overall_status }}

          ### ðŸ“Š Quality Metrics Summary

          | Metric | Current | Baseline | Progress |
          |--------|---------|----------|-----------|
          | **ESLint Warnings** | ${{ steps.quality.outputs.current_warnings }} | ${{ steps.quality.outputs.baseline_warnings }} | $(if [ "${{ steps.quality.outputs.warning_reduction }}" -gt 0 ]; then echo "âœ… -${{ steps.quality.outputs.warning_reduction }} (-${{ steps.quality.outputs.warning_percentage }}%)"; else echo "âž– No change"; fi) |
          | **Dead Code** | ${{ steps.quality.outputs.unused_exports }} | ${{ steps.quality.outputs.deadcode_baseline }} | $(if [ "${{ steps.quality.outputs.deadcode_reduction }}" -gt 0 ]; then echo "âœ… -${{ steps.quality.outputs.deadcode_reduction }}"; else echo "âž– No change"; fi) |
          | **Quality Gates** | ${{ steps.quality.outputs.gates_passed }}/5 passed | - | $(if [ "${{ steps.quality.outputs.gates_failed }}" -eq 0 ]; then echo "âœ… All passing"; else echo "âŒ ${{ steps.quality.outputs.gates_failed }} failed"; fi) |

          ### ðŸŽ¯ Coverage Highlights
          - **Overall Coverage:** ${{ steps.coverage.outputs.overall_coverage }}%
          - **Branch Coverage:** ${{ steps.coverage.outputs.branch_coverage }}%

          ### âš ï¸ Top Warning Categories
          \`\`\`
          ${{ steps.warnings.outputs.top_warnings }}
          \`\`\`

          ### ðŸš€ Next Steps
          $(if [ "${{ steps.quality.outputs.gates_failed }}" -gt 0 ]; then
            echo "- Fix ${{ steps.quality.outputs.gates_failed }} failing quality gate(s)"
          fi)
          $(if [ "${{ steps.quality.outputs.current_warnings }}" -gt 400 ]; then
            echo "- Consider reducing ESLint warnings toward <400 target"
          fi)
          $(if [ "${{ steps.quality.outputs.unused_exports }}" -gt 200 ]; then
            echo "- Consider cleaning up unused exports toward <200 target"
          fi)
          $(if [ "${{ steps.quality.outputs.gates_failed }}" -eq 0 ] && [ "${{ steps.quality.outputs.current_warnings }}" -le 400 ]; then
            echo "ðŸŽ‰ Excellent work! This PR meets all quality standards."
          fi)

          ---
          *Generated by Quality Report Bot â€¢ Run: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ Commit: \`${{ github.sha }}\`*
          EOF

      - name: Find existing PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3
        id: find-comment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## ðŸ›¡ï¸ Code Quality Report'

      - name: Create or update PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr_comment.md
          edit-mode: replace

  # Optional security scan (reuses build from test job)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Dependency audit
        run: npm audit --audit-level moderate || true

      - name: CodeQL Analysis
        uses: github/codeql-action/init@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v3
        with:
          languages: typescript
          queries: security-and-quality
          config-file: ./.github/workflows/codeql/codeql-config.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v3