graph TD
    %% Container Kit MCP - Three-Layer Architecture
    %% Updated to reflect actual codebase structure as of July 2025
    %% 606 Go files, 159,570 lines of code, 126MB codebase

    Client[MCP Client] --> Transport[infra/transport/]
    Transport --> Server[application/core/]
    Server --> API[application/api/]

    subgraph "Domain Layer (Business Logic)"
        Domain[domain/]

        subgraph "Domain Packages (101 Go files)"
            Config[domain/config/<br/>Tag-based Validation DSL]
            Containerization[domain/containerization/<br/>analyze/, build/, deploy/, scan/]
            Errors[domain/errors/<br/>Unified RichError System]
            Security[domain/security/<br/>Security Policies]
            Session[domain/session/<br/>Session Entities]
            Types[domain/types/<br/>Core Domain Types]
            Workflow[domain/workflow/<br/>Workflow Domain Logic]
            Internal[domain/internal/<br/>common/, utils/, types/]
        end

        Domain --> Config
        Domain --> Containerization
        Domain --> Errors
        Domain --> Security
        Domain --> Session
        Domain --> Types
        Domain --> Workflow
        Domain --> Internal
    end

    subgraph "Application Layer (Use Cases & Orchestration)"
        Application[application/]

        subgraph "Application Packages (153 Go files)"
            API[application/api/<br/>831 Lines - Canonical Interfaces<br/>Single Source of Truth]
            Commands[application/commands/<br/>Consolidated Implementations<br/>Tool Registration & FileAccessService]
            Core[application/core/<br/>Server & Registry Management]
            Conversation[application/conversation/<br/>Chat & Auto-fix]
            Interfaces[application/interfaces/<br/>Compatibility Layer<br/>Type aliases for backward compatibility]
            Knowledge[application/knowledge/<br/>Knowledge Management]
            Orchestration[application/orchestration/<br/>Tool Coordination]
            Services[application/services/<br/>Service Interfaces & Container<br/>21 Services including FileAccessService]
            State[application/state/<br/>State Management]
            Tools[application/tools/<br/>Tool Implementations]
            Workflows[application/workflows/<br/>Workflow Engine]
            AppInternal[application/internal/<br/>conversation/, runtime/, retry/]
        end

        Application --> API
        Application --> Commands
        Application --> Core
        Application --> Conversation
        Application --> Interfaces
        Application --> Knowledge
        Application --> Orchestration
        Application --> Services
        Application --> State
        Application --> Tools
        Application --> Workflows
        Application --> AppInternal
    end

    subgraph "Infrastructure Layer (External Integrations)"
        Infrastructure[infra/]

        subgraph "Infrastructure Components (38 Go files)"
            Persistence[infra/persistence/<br/>BoltDB Storage]
            Templates[infra/templates/<br/>YAML Templates with go:embed]
            Transport[infra/transport/<br/>MCP Protocol - stdio, HTTP]
            FileAccess[infra/file_access.go<br/>FileAccessService Implementation<br/>Secure File Operations]
            DockerInfra[infra/docker/<br/>Docker Client Integration]
            K8sInfra[infra/k8s/<br/>Kubernetes Integration]
            Telemetry[infra/telemetry/<br/>Prometheus & OpenTelemetry]
            InfraInternal[infra/internal/<br/>logging/, migration/]
        end

        Infrastructure --> Persistence
        Infrastructure --> Templates
        Infrastructure --> Transport
        Infrastructure --> FileAccess
        Infrastructure --> DockerInfra
        Infrastructure --> K8sInfra
        Infrastructure --> Telemetry
        Infrastructure --> InfraInternal
    end

    %% Dependency Rules (per ADR-001)
    %% Application can depend on Domain
    API --> Domain
    Commands --> Domain
    Core --> Domain
    Conversation --> Domain
    Interfaces --> Domain
    Knowledge --> Domain
    Orchestration --> Domain
    Services --> Domain
    State --> Domain
    Tools --> Domain
    Workflows --> Domain
    AppInternal --> Domain

    %% Infrastructure can depend on Application and Domain
    Persistence --> Application
    Templates --> Application
    Transport --> Application
    Retry --> Application
    DockerInfra --> Application
    K8sInfra --> Application
    Telemetry --> Application
    InfraInternal --> Domain

    %% Service Container Pattern (ADR-006)
    subgraph "Service Container (Manual Dependency Injection)"
        ServiceContainer[ServiceContainer<br/>21 Services Including FileAccessService]
        SessionStore[SessionStore<br/>Session CRUD]
        SessionState[SessionState<br/>State & Checkpoints]
        BuildExecutor[BuildExecutor<br/>Container Operations]
        ToolRegistry[ToolRegistry<br/>Tool Management]
        WorkflowExecutor[WorkflowExecutor<br/>Multi-step Workflows]
        Scanner[Scanner<br/>Trivy & Grype]
        ConfigValidator[ConfigValidator<br/>Tag-based Validation]
        ErrorReporter[ErrorReporter<br/>Unified Error Handling]
        FileAccessSvc[FileAccessService<br/>Secure File Operations<br/>Session-based Workspace Isolation]
    end

    Core --> ServiceContainer
    ServiceContainer --> SessionStore
    ServiceContainer --> SessionState
    ServiceContainer --> BuildExecutor
    ServiceContainer --> ToolRegistry
    ServiceContainer --> WorkflowExecutor
    ServiceContainer --> Scanner
    ServiceContainer --> ConfigValidator
    ServiceContainer --> ErrorReporter
    ServiceContainer --> FileAccessSvc
    FileAccessSvc --> FileAccess

    %% External Systems Integration
    DockerInfra --> DockerEngine[Docker Engine]
    K8sInfra --> KubernetesAPI[Kubernetes API]
    Persistence --> BoltDB[BoltDB Files<br/>Session Storage]
    Scanner --> Trivy[Trivy Scanner]
    Scanner --> Grype[Grype Scanner]
    Telemetry --> Prometheus[Prometheus Metrics]
    Telemetry --> OpenTelemetry[OpenTelemetry Tracing]

    %% Architecture Validation (ADR-001)
    %% - Domain: 101 files, no dependencies (pure business logic)
    %% - Application: 153 files, depends only on Domain
    %% - Infrastructure: 38 files, depends on Application and Domain
    %% Total: 606 Go files, 159,570 lines of code
    %%
    %% FileAccessService Implementation:
    %% - Real implementation in infra/file_access.go
    %% - Service interface in application/services/interfaces.go
    %% - 12 tools including 3 file access tools
    %% - Session-based workspace isolation
    %% - Security validation and path traversal protection

    classDef domainLayer fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef applicationLayer fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    classDef infraLayer fill:#fff3e0,stroke:#ef6c00,stroke-width:3px
    classDef serviceLayer fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
    classDef externalSys fill:#eceff1,stroke:#455a64,stroke-width:1px,stroke-dasharray: 5 5

    class Domain,Config,Containerization,Errors,Security,Session,Types,Workflow,Internal domainLayer
    class Application,API,Commands,Core,Conversation,Interfaces,Knowledge,Orchestration,Services,State,Tools,Workflows,AppInternal applicationLayer
    class Infrastructure,Persistence,Templates,Transport,Retry,DockerInfra,K8sInfra,Telemetry,InfraInternal infraLayer
    class ServiceContainer,SessionStore,SessionState,BuildExecutor,ToolRegistry,WorkflowExecutor,Scanner,ConfigValidator,ErrorReporter,FileAccessSvc serviceLayer
    class DockerEngine,KubernetesAPI,BoltDB,Trivy,Grype,Prometheus,OpenTelemetry externalSys
