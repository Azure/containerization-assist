@startuml Container Kit MCP - Simplified Four-Layer Architecture
!theme plain
title Container Kit MCP Server - Simplified Four-Layer Architecture\nDirect Dependency Injection with Tool-Driven Design

' Define layer colors
!define API_COLOR #E8F5E9
!define SERVICE_COLOR #E3F2FD  
!define DOMAIN_COLOR #F3E5F5
!define INFRA_COLOR #FFF3E0

package "External Clients" {
  [Claude Desktop] as Client
  [CLI Tools] as CLI
  [HTTP Clients] as HTTP
}

package "Transport Layer" {
  [MCP Protocol] as Protocol
  [HTTP Transport] as HTTPTransport
  [Stdio Transport] as StdioTransport
}

rectangle "**API Layer**" API_COLOR {
  package "Essential Interfaces" {
    [Tool Interface] as ToolAPI
    [Server Interface] as ServerAPI
    [Workflow Interface] as WorkflowAPI
    [Session Interface] as SessionAPI
  }
  note right of ToolAPI : Pure interfaces only\nNo implementation code\nStable contracts
}

rectangle "**Service Layer**" SERVICE_COLOR {
  package "MCP Server" {
    [Server Core] as Server
    [Transport Manager] as TransportMgr
    [Session Service] as SessionSvc
  }
  
  package "Tool Registry" {
    [Tool Registry] as ToolRegistry
    [15 Individual Tools] as Tools
    [Chain Hints] as ChainHints
  }
  
  package "Direct DI" {
    [Dependencies Struct] as Dependencies
    [Server Factory] as ServerFactory
  }
  
  note right of ToolRegistry : 15 tools total:\n• 10 workflow tools\n• 2 orchestration tools\n• 3 utility tools
}

rectangle "**Domain Layer**" DOMAIN_COLOR {
  package "Workflow" {
    [Workflow Orchestrator] as Orchestrator
    [Step Factory] as StepFactory
    [Workflow Types] as WorkflowTypes
  }
  
  package "Events & Progress" {
    [Domain Events] as Events
    [Progress Tracking] as Progress
  }
  
  package "Error Handling" {
    [Workflow Error] as WorkflowError
  }
  
  note right of Orchestrator : Direct orchestration\nStep-based execution\nSession state management
}

rectangle "**Infrastructure Layer**" INFRA_COLOR {
  package "Workflow Steps" {
    [analyze_repository] as Step1
    [generate_dockerfile] as Step2
    [build_image] as Step3
    [scan_image] as Step4
    [tag_image] as Step5
    [push_image] as Step6
    [generate_k8s_manifests] as Step7
    [prepare_cluster] as Step8
    [deploy_application] as Step9
    [verify_deployment] as Step10
  }
  
  package "AI Integration" {
    [Sampling Client] as SamplingClient
    [Prompt Manager] as PromptMgr
  }
  
  package "Unified Infrastructure" {
    [Unified Messaging] as Messaging
    [Unified Observability] as Observability
  }
  
  package "External Systems" {
    [Docker Client] as DockerClient
    [Kubernetes Client] as K8sClient
    [BoltDB Storage] as BoltStore
  }
  
  note right of Messaging : Consolidated:\n• Event publishing\n• Progress reporting\n• CLI and MCP direct
}

' External Systems
cloud "External Dependencies" {
  [Azure OpenAI] as AzureAI
  [Docker Engine] as Docker
  [Kubernetes Cluster] as K8s
  [Container Registry] as Registry
}

' Layer Dependencies (Clean Architecture)
API_COLOR -[hidden]down-> SERVICE_COLOR
SERVICE_COLOR -[hidden]down-> DOMAIN_COLOR  
DOMAIN_COLOR -[hidden]down-> INFRA_COLOR

' Client connections
Client --> Protocol
CLI --> Protocol
HTTP --> HTTPTransport
Protocol --> Server

' Transport connections
HTTPTransport --> Server
StdioTransport --> Server

' Service layer dependencies
Server --> Dependencies
Dependencies --> ServerFactory
ServerFactory --> ToolRegistry
ToolRegistry --> Tools
Tools --> ChainHints
Server --> SessionSvc

' Domain layer dependencies  
Tools --> Orchestrator
Orchestrator --> StepFactory
Orchestrator --> Events
Orchestrator --> Progress
Orchestrator --> WorkflowError

' Infrastructure layer dependencies
StepFactory --> Step1
Step1 --> Step2
Step2 --> Step3
Step3 --> Step4
Step4 --> Step5
Step5 --> Step6
Step6 --> Step7
Step7 --> Step8
Step8 --> Step9
Step9 --> Step10

' Tool chaining
Step1 -.-> Step2 : chain hint
Step2 -.-> Step3 : chain hint
Step3 -.-> Step4 : chain hint
Step4 -.-> Step5 : chain hint
Step5 -.-> Step6 : chain hint
Step6 -.-> Step7 : chain hint
Step7 -.-> Step8 : chain hint
Step8 -.-> Step9 : chain hint
Step9 -.-> Step10 : chain hint

' AI integration
Step2 --> SamplingClient
Step3 --> SamplingClient
SamplingClient --> PromptMgr

' Unified infrastructure
Events --> Messaging
Progress --> Messaging
Orchestrator --> Observability

' External integrations
Step3 --> DockerClient
Step6 --> DockerClient
Step8 --> K8sClient
Step9 --> K8sClient
Step10 --> K8sClient
SessionSvc --> BoltStore

' External system connections
SamplingClient --> AzureAI
DockerClient --> Docker
K8sClient --> K8s
Step6 --> Registry

' Architecture notes
note top of Dependencies : **Direct Dependency Injection**\n• Simple Dependencies struct\n• No code generation needed\n• Clear initialization order

note top of Tools : **Tool-Driven Architecture**\n• Table-driven configuration\n• Individual focused tools\n• Intelligent tool chaining

note top of WorkflowError : **Simple Error Handling**\n• Step name + attempt number\n• Standard error wrapping\n• Lightweight design

note top of Messaging : **Unified Infrastructure**\n• Consolidated packages\n• Reduced complexity\n• Single responsibility

@enduml