graph TB
    %% External Clients
    subgraph "External Clients"
        Claude[Claude Desktop]
        CLI[MCP CLI]
        HTTP[HTTP Clients]
    end

    %% API Layer
    subgraph "API Layer"
        Interfaces[MCP Tool Interfaces<br/>Pure Contracts]
    end

    %% Service Layer
    subgraph "Service Layer"
        subgraph "MCP Server"
            Server[Server Core]
            DI[Direct Dependencies]
            Transport[Transport Manager]
        end
        
        subgraph "Tool Registry"
            Registry[Tool Registry<br/>15 Tools]
            Tools[Individual Tools<br/>10 Workflow + 2 Orchestration + 3 Utility]
            Chains[Chain Hints]
        end
        
        subgraph "Session Management"
            Session[Session Service]
            State[Workflow State]
        end
    end

    %% Domain Layer
    subgraph "Domain Layer"
        subgraph "Workflow"
            Orchestrator[Workflow Orchestrator]
            StepFactory[Step Factory]
        end
        
        subgraph "Events & Progress"
            Events[Domain Events]
            Progress[Progress Tracking]
        end
        
        subgraph "Error Handling"
            WorkflowError[Workflow Error<br/>Step + Attempt]
        end
    end

    %% Infrastructure Layer
    subgraph "Infrastructure Layer"
        subgraph "Workflow Steps"
            Step1[analyze_repository]
            Step2[generate_dockerfile]
            Step3[build_image]
            Step4[scan_image]
            Step5[tag_image]
            Step6[push_image]
            Step7[generate_k8s_manifests]
            Step8[prepare_cluster]
            Step9[deploy_application]
            Step10[verify_deployment]
        end
        
        subgraph "AI/ML Services"
            Sampling[LLM Sampling Client]
            Prompts[Prompt Manager]
        end
        
        subgraph "Unified Infrastructure"
            Messaging[Unified Messaging<br/>Events + Progress]
            Observability[Unified Observability<br/>Tracing + Health]
        end
        
        subgraph "External Integrations"
            Docker[Docker Client]
            K8s[Kubernetes Client]
            Storage[BoltDB Storage]
        end
    end

    %% External Services
    subgraph "External Services"
        OpenAI[Azure OpenAI]
        DockerEngine[Docker Engine]
        K8sCluster[Kubernetes Cluster]
        Registry[Container Registry]
    end

    %% Connections
    Claude --> Server
    CLI --> Server
    HTTP --> Server
    
    Server --> DI
    Server --> Transport
    Server --> Registry
    
    Registry --> Tools
    Tools --> Chains
    Tools --> Session
    
    Tools --> Orchestrator
    Orchestrator --> StepFactory
    Orchestrator --> Events
    Orchestrator --> Progress
    Orchestrator --> WorkflowError
    
    StepFactory --> Step1
    Step1 --> Step2
    Step2 --> Step3
    Step3 --> Step4
    Step4 --> Step5
    Step5 --> Step6
    Step6 --> Step7
    Step7 --> Step8
    Step8 --> Step9
    Step9 --> Step10
    
    Step2 --> Sampling
    Step3 --> Sampling
    Sampling --> Prompts
    
    Step3 --> Docker
    Step6 --> Docker
    Step8 --> K8s
    Step9 --> K8s
    Step10 --> K8s
    
    Session --> Storage
    Events --> Messaging
    Progress --> Messaging
    Orchestrator --> Observability
    
    Sampling --> OpenAI
    Docker --> DockerEngine
    K8s --> K8sCluster
    Step6 --> Registry

    %% Chain hints between tools
    Step1 -.-> Step2 : "Chain Hint"
    Step2 -.-> Step3 : "Chain Hint"
    Step3 -.-> Step4 : "Chain Hint"
    Step4 -.-> Step5 : "Chain Hint"
    Step5 -.-> Step6 : "Chain Hint"
    Step6 -.-> Step7 : "Chain Hint"
    Step7 -.-> Step8 : "Chain Hint"
    Step8 -.-> Step9 : "Chain Hint"
    Step9 -.-> Step10 : "Chain Hint"

    %% Session state persistence
    Step1 -.-> State : "Session State"
    Step10 -.-> State : "Session State"

    %% Styling
    classDef external fill:#f9f,stroke:#333,stroke-width:2px
    classDef api fill:#dfd,stroke:#333,stroke-width:2px
    classDef service fill:#ddf,stroke:#333,stroke-width:2px
    classDef domain fill:#fdf,stroke:#333,stroke-width:2px
    classDef infra fill:#ffd,stroke:#333,stroke-width:2px
    classDef externalSvc fill:#ffe,stroke:#333,stroke-width:2px
    
    class Claude,CLI,HTTP external
    class Interfaces api
    class Server,DI,Transport,Registry,Tools,Chains,Session,State service
    class Orchestrator,StepFactory,Events,Progress,WorkflowError domain
    class Step1,Step2,Step3,Step4,Step5,Step6,Step7,Step8,Step9,Step10,Sampling,Prompts,Messaging,Observability,Docker,K8s,Storage infra
    class OpenAI,DockerEngine,K8sCluster,Registry externalSvc